% script basic Kalman Filtering

% save image from singleBall.avi
video = vision.VideoFileReader('singleball.avi');
player = vision.DeployableVideoPlayer('Location', [10,100]);

while playControls
    while ~isDone(video)
        step(player,step(video));
    end
    reset(video);
end
delete(player);
%% Detect the ball in the video

fgDetector = vision.ForegroundDetector(...
    'NumTrainingFrames', 10, 'InitialVariance', 0.05);
blobAnalyzer = vision.BlobAnalysis('AreaOutputPort', true, ...
    'MinimumBlobArea', 70, 'CentroidOutputPort', true);
player = vision.DeployableVideoPlayer('Location', [10,100]);
fgPlayer = vision.DeployableVideoPlayer('Location', player.Location + [500 120]);
reset(video);
while playControls
    while ~isDone(video)
        image = step(video);
        I = rgb2gray(image);
        fgMask = step(fgDetector,I);
        fgMask = bwareaopen(fgMask,25);
        [~, detection] = step(blobAnalyzer,fgMask);
        step(fgPlayer,fgMask);
        if ~isempty(detection)
            position = detection(1,:);
            position(:,3) = 10;
            combinedImage = insertObjectAnnotation(image,'circle',position,'Ball');
            step(player,combinedImage);
        else
            step(player, image);
        end
        step(fgPlayer,fgMask);
    end
    reset(video);
end